@(address:Address)(cartlist:List[ShoppingCartEndorse])(usr:User)(Isopenid:String)(Postfee:String)(taxfee:String)(tfee:String)(datastr:String)(pidstr:String)(addrSign:WxSign)(appid:String)(postmanid:String)(wxtoken:String)@views.html.sheSaid.main{<title>订单结算</title><script type="text/javascript" src="@assets.CdnAssets.urlForAPIPublic("javascripts/sheSaidJs/cityPanel/cityPanel.js")"></script><link rel="stylesheet" type="text/css" href="@assets.CdnAssets.urlForAPIPublic("stylesheets/sheSaidCSS/cityPanel/cityPanel.css")" media="all"><script src="@assets.CdnAssets.urlForAPIPublic("javascripts/sheSaidJs/alert.js")"></script><style>		    		    .certificates{				padding:6px 10px 10px;				}		 	.certificates b{				color:#ff314e;								font-size:12px;				font-weight:400;							}			.certificates p,.certificates input{				color:#303030;				font-size:13px;				line-height:28px;				border-radius:3px;				background:#e4e4e4;				padding:0 2%;				width:96%;				border:none;								}					.login-wrap{				position:absolute;				top:50%;				left:20px;				right:20px;				margin:-160px 0 0 0;				border-radius:6px;				background:#fff;				padding:30px;				box-shadow:0 0 3px #cacacd;						}			.login-wrap h2{				display:block;				text-align:center;				font-size:16px;				line-height:22px;				}				.login{				border-bottom:0;				}					.transparent{		      position: fixed;		      top:0;		      left:0;		      right:0;		      bottom:0;		      background:rgba(0,0,0,.5);		      }		     .person_input-wrap label{			    float:left;			    margin:0;			    padding:0;			    line-height:46px;			    width:50px;			   }			   .person_input-wrap p{			    margin-left:50px;			    } 			   .person_input{			    width:96%;			    text-overflow:ellipsis;			   }   	  	    	  	  	  	        </style>}{<div class="container"><form name="form1" id="form1" method="post" action="/sheSaid/saveOrder">		<input type="hidden" id="aid" name="aid" value="@if(address!=null){@address.getAddressId()}"/>		<input type="hidden" id="proid" name="proid" value="0" />		<input type="hidden" id="uid" name="uid" value="@usr.getUid()" />		<input type="hidden" id="count" name="count" value="1" />			<div class="nav-top">               <p>订单结算</p>               <i class="ico-return" onclick="javascript:history.back();"></i>               <i class="ico-basket" onclick="javascript:window.location.href='@assets.CdnAssets.H5_SHOPPING_URL(postmanid)'"></i>         </div>		<!-- 选择微信地址 -->		<div class="address" id="wxaddress" name="wxaddress" onclick="selectwxaddress()" style="margin-top:5px;display:none">                <div class="address_info">                    <p class="name">                        <label id="wxname">@if(address.getName()==""){请填写收货人信息}else{@address.getName()}</label>                        <label id="wxphone">@if(address.getName()!=""){@address.getPhone()}</label>                    </p>                    <p class="txt" id="wxdress">                      @address.getProvince()@address.getAddress()                    </p>                </div>                <i class="ico_arrow_right"></i>            </div>         <!-- 微信选择地址结束 -->				 <div class="cont person" style="z-index:1000" id="showaddress" name="showaddress">      			 <div class="person_input-wrap">			 <label>收货人信息</label>			 </div>              <div class="person_input-wrap">              <label>姓名：</label>				<p><input type="text" class="person_input" placeholder="收货人真实姓名" id="Name" name="Name"  value="@address.getName()"></p>              </div>              <div class="person_input-wrap">              <label>电话：</label>				<p><input type="tel" class="person_input" placeholder="手机号码" id="phone" name="phone" value="@address.getPhone()"></p>              </div>              <div class="person_input-wrap">              <label>地址：</label>				<p><input type="text" class="person_input city_dummy" name="city_dummy" id="city_dummy" placeholder="所在地区" value="@address.getProvince()" readOnly></p>                 <i class="ico_arrow_right city_dummy"></i>              </div>              <div class="person_input-wrap">              <p><input type="text" class="person_input" placeholder="详细地址" id="address" name="address" value="@address.getAddress()"></p>              </div>                           	</div>	@if(Isopenid=="1"){			<div class="cont certificates">		              <b>应海关要求请填写真实身份证信息，以确保正常收货！</b>		              <input type="text" id="cardId" name="cardId" placeholder="身份证号" value="@address.getCardId()" />		    </div>		    }else{              <input type="hidden" id="cardId" name="cardId" value="@address.getCardId()" />              }  	   @if(cartlist!=null){   	@for(proinfo <- cartlist){	<div class="cont product" style="margin-top:10px;">		<div class="product_img">			<img src="@proinfo.getProinfo.getListpic()" alt="@proinfo.getProinfo.getTitle()">		</div>		<div class="product_neme">@Html(proinfo.getProinfo().getTitle())</div>		<div class="product_info">		<span>数量：<b id="pricep">@proinfo.getCounts()</b></span>		<em>￥@if(proinfo.getProinfo().getEndorsementPrice().toInt<proinfo.getProinfo().getEndorsementPrice()){@proinfo.getProinfo().getEndorsementPrice()}else{@proinfo.getProinfo().getEndorsementPrice().toInt}</em>		</div>	</div>		}	}@if(Postfee.toDouble>0 || taxfee.toDouble>0){	<div style="margin-top:10px;background-color:#fff">		<ul class="detail">			@if(Postfee.toDouble>0){			<li>				<div>					<span>运费</span> <em id="postfee">￥@Postfee</em>				</div>			</li>			}			@if(taxfee.toDouble>0){						<li>							<div>											<span>费税</span> <em>￥@taxfee</em>										</div>									</li>			}		</ul>	</div>}<div class="cont-h115"></div>	<div class="cont fixed">		<div class="product_pay">			<p>				<em>合计:<b id="hjprice">￥@tfee</b></em>包含运费			</p>			<a href="#" class="btn btn_finish" id="onsubreg" onclick="submito()"><span id="innertxt">微信支付</span></a>		</div>	</div></form></div><!-- 登录区 --><input type="hidden" id="flg" name="flg" value="orderlist" /><div class="transparent" id="showlogin" style="z-index:3000;display:none"><div class="container" id="showlogin" onclick=""><div class="login-wrap">	<h2>                  验证手机号<br>                  便于您按时收货    </h2>	<div class="login">		<form name="form1" id="form1" method="post" action="/api/checkUserVerify">		<input type="hidden" id="openid" name="openid" value="@usr.getOpenId()"/>		<input type="hidden" id="unionid" name="unionid" value="@usr.getUnionid()"/>		<input type="hidden" id="uid" name="uid" value="@usr.getUid()" />		<div class="input-wrap input-wrap-b">			<input type="text" id="phonereg" name="phonereg" class="input tel" placeholder="手机号">		</div>		<div class="input-wrap">			<input type="hidden" id="imgcheck" name="imgcheck" />			<input type="text" id="verify_sms" name="verify_sms" class="input letter" placeholder="短信验证码">			<a href="#" class="btn btn_code"><span id="sendsms" onclick="setDivCenter()">发送验证码</span></a>		</div>		</form>	</div>	<div class="protocol">		<p>			<i class="new_check"></i><a href="http://ht.neolix.cn/www/service/agreement.html">嗨个购用户协议</a>		</p>		<p>			<a href="#" class="btn btn_finish" onclick="checkuser()">完成</a>		</p>	</div>	<a href="javascript:;" class="pop-pay-close" onclick="closeshowlogin()"></a></div>	</div></div><!-- 登录区结束 -->   <div class="load" style='display: block;z-index:3000'></div>}{<script>              $(function(){				 $(".city_dummy").cityPanel();			  }) </script><script type="text/javascript"><!-- var ua = window.navigator.userAgent.toLowerCase();var bw=false;if(ua.match(/MicroMessenger/i) == 'micromessenger'){	bw=true;	document.getElementById("showaddress").style.display="none";	document.getElementById("wxaddress").style.display="";	//document.getElementById("Name").value="";			//document.getElementById("phone").value="";			//document.getElementById("city_dummy").value="";			//document.getElementById("address").value="";	}else{	bw=false;	document.getElementById("innertxt").innerHTML="请使用微信购买";	document.getElementById("onsubreg").onclick="";	//document.getElementById("showaddress").style.display="";	//document.getElementById("wxaddress").style.display="none";}@if(cartlist==null){	document.getElementById("onsubreg").onclick="";}@if(usr.getUid()==0){		document.getElementById("onsubreg").onclick=function(){submitlogin();};}function submitlogin(){	checkaddress();	if(asuc==true)		document.getElementById("showlogin").style.display="";}function closeshowlogin(){	document.getElementById("showlogin").style.display="none";	if(bw){		//window.location.href="/sheSaid/ordercartcrm@if(addrSign!=null){?code=@addrSign.getCode()&state=@addrSign.getState()}";		document.getElementById("showaddress").style.display="";	    document.getElementById("wxaddress").style.display="none";		}}//选择微信地址function selectwxaddress(){		@if(addrSign!=null && wxtoken!=""){		callpay();	}else{		window.location.href="/H5/wxauth_address?flg=cart";	}}/* * 调用微信地址JS */ function callpay() { 	if (typeof WeixinJSBridge == "undefined"){ 		if( document.addEventListener ){ 			document.addEventListener('WeixinJSBridgeReady', jsApiCall, false); 		}else if (document.attachEvent){ 			document.attachEvent('WeixinJSBridgeReady', jsApiCall);  			document.attachEvent('onWeixinJSBridgeReady', jsApiCall); 		} 	}else{ 		jsApiCall(); 	} } function jsApiCall() {	 @if(addrSign!=null){ 	WeixinJSBridge.invoke( 		'editAddress',{            "appId" : "@addrSign.getAppId()",     //公众号名称，由商户传入                 "scope":"jsapi_address",            "signType":"sha1",            "addrSign":"@addrSign.getSign()",            "timeStamp":"@addrSign.getTimstr()",         //时间戳，自1970年以来的秒数                 "nonceStr" : "@addrSign.getNostr()" //随机串           }, 		function(res){     	   //alert(res.err_msg); 			if(res.err_msg == "edit_address:ok" ) { 				//成功 				document.getElementById("Name").value=res.userName; 				//alert(document.getElementById("Name").value); 				document.getElementById("phone").value=res.telNumber; 				document.getElementById("city_dummy").value=res.addressCitySecondStageName+res.addressCountiesThirdStageName; 				document.getElementById("address").value=res.addressDetailInfo; 				document.getElementById("showaddress").style.display="none";	 				document.getElementById("wxdress").innerHTML=res.addressCitySecondStageName+res.addressCountiesThirdStageName+res.addressDetailInfo; 				document.getElementById("wxname").innerHTML=res.userName; 				document.getElementById("wxphone").innerHTML="<br>"+res.telNumber; 			}else{ 				//window.location.href="/H5/wxauth_address?flg=cart"; 				document.getElementById("showaddress").style.display=""; 				document.getElementById("wxaddress").style.display="none"; 			} 		} 	);	 } } /***********调用微信地址结束**********/var addressid='@address.getAddressId()';var asuc=true;var checkuserid='@usr.getUid()';function checkaddress(){	asuc=true;	 var reg = /^1\d{10}$/g; 	 if(!reg.test(document.getElementById("phone").value)){		 if(!bw)			 _alert("请输入正确的手机号!");		 else			 _alert("请选择地址");	 	asuc=false;	 	return false;	 }	 	if(document.getElementById("Name").value==""){	 	if(!bw)	 		_alert("请输入收货人!");	 	else	 		_alert("请选择地址");	 	asuc=false;	 	return false;	 }	if(document.getElementById("Name").value.length>16){	 	if(!bw)	 		_alert("收货人不能超过16个字符!");	 	else	 		_alert("请选择地址");	 	asuc=false;	 	return false;	 }	 if(document.getElementById("address").value==""){	 	if(!bw)	 		_alert("请输入详细地址!");	 	else	 		_alert("请选择地址");	 	asuc=false;	 	return false;	 }	 if(document.getElementById("address").value.length>100){		 	if(!bw)		 		_alert("详细地址不能超过100个字符!");		 	else		 		_alert("请选择地址");		 	asuc=false;		 	return false;	}	 	 if(document.getElementById("city_dummy").value==""){	 	if(!bw)	 		_alert("请输入所在地区!");	 	else	 		_alert("请选择地址");	 	asuc=false;	 	return false;	 }	 @if(Isopenid=="1"){		 if(document.getElementById("cardId").value.length<15){			 _alert("请输入身份证号!");			 asuc=false;			 return false;		 }	 }}function setDivCenter(){  		if ($("#phonereg").val().match(/^((1[0-9]{1})+\d{9})$/)) {		verifySMS();	}	else{   	 	_alert("请输入正确的手机号!");		return false;    }}var flag='';var reg = /^1\d{10}$/g; var miao = 60;var iswx="1";function verifySMS(){    	//alert(iswx);	//if($("#imgcheck").val().length==4)		checkisimg=true;	//if(iswx=="1")	checkisimg=true;	miao=60;	var pho=document.getElementById("phonereg").value;  	var imc=document.getElementById("imgcheck").value;	if ($("#phonereg").val().match(/^((1[0-9]{1})+\d{9})$/)) {		if(checkisimg==true){   		time_op();   		 $.ajax({           //提交数据的类型 POST GET           type:"POST",           //提交的网址           url:"/H5/userVerify",           //提交的数据           data:{uid:"@usr.getUid()",phone:pho,reg:"0",imgcheck:imc,wx:iswx},           //返回数据的格式           datatype: "json",//"xml", "html", "script", "json", "jsonp", "text".           //在请求之前调用的函数           beforeSend:function(){},           //成功返回之后调用的函数                       success:function(data){                                    		if(data.status=="1"){         			_alert("验证码已成功发送!");         		}else{         			_alert(data.msg);         		}           }   ,           //调用执行后调用的函数           complete: function(XMLHttpRequest, textStatus){           },           //调用出错执行的函数           error: function(){               //请求出错处理               _alert("发送失败!");           }                	});   		}else{			_alert("请输入图形验证码!");			return false;		}    }    else{   	 	_alert("请输入正确的手机号!");		return false;    }}function time_op() {		miao--;	if(miao>0){		document.getElementById("sendsms").innerHTML = miao+"秒";		document.getElementById("sendsms").onclick="";	}	else	{			//$("#sendsms").attr("onclick","verifySMS()");		document.getElementById("sendsms").onclick=function(){setDivCenter();};		document.getElementById("sendsms").innerHTML = "重新发送";	}	if(miao>0){		setTimeout("time_op()", "1000");	}}/*检查注册填写项并注册*/function checkuser(){	var pho=document.getElementById("phonereg").value; 	var ver=document.getElementById("verify_sms").value;	var suc=true;		if (!$("#phonereg").val().match(/^1\d{10}$/g)) {		_alert("请输入正确的手机号");		suc=false;	}	else{    	if(ver.length<1){    		suc=false;    		_alert("请输入验证码")    	}	}    		if(suc){	$.ajax({        type:"POST",        url:"/sheSaid/reguser",        data:{uid:'@usr.getUid()',verify_sms:ver,phone:pho,unionid:'@usr.getUnionid()',openid:'@usr.getOpenId()',mcode:'H5'},        datatype: "json",//"xml", "html", "script", "json", "jsonp", "text"        beforeSend:function(){},                success:function(data){      		if(data.status=="1"){      			//注册成功添加购物车         			tempuid=data.uid;      			saveorder(data.uid);       		}else{      			_alert(data.msg);      		}        }   ,        complete: function(XMLHttpRequest, textStatus){        },        error: function(){            _alert("请输入正确的验证码!");        }             });   	     }}$('.load').fadeOut("slow");	function submito(){	var aid="@if(address!=null){address.getAddressId()}";		var aid=document.getElementById("aid").value;		var uid=document.getElementById("uid").value;						//alert(datastr);		var suc=asuc;				aid=addressid;		if(aid.length<1 || uid.length<1){			_alert("请填写收货地址!");			suc=false;		}		aid=addressid;		checkaddress();		if(asuc){			$('.load').fadeIn();				saveorder(uid);		} }	function saveorder(uid){		var datastr='@datastr';		$.ajax({            type:"POST",            url:"/H5/saveaddress",            data:{aid:addressid,uid:uid,Name:document.getElementById("Name").value,phone:document.getElementById("phone").value,address:document.getElementById("address").value,city_dummy:document.getElementById("city_dummy").value,cardid:document.getElementById("cardId").value,pids:'@pidstr'},            datatype: "json",//"xml", "html", "script", "json", "jsonp", "text".            beforeSend:function(){},  	           success:function(data){	        	   	         	if(data.status=="1"){		         		//alert("ok"+data.aid);	         		addressid=data.aid;	         		if(bw){						$.ajax({			            type:"POST",			            url:"/api/shoppingOrder_new",					            			            data:{datastr:datastr,uid:uid,addressid:addressid,typ:66,mcode:'sheSaid'},			            datatype: "json",//"xml", "html", "script", "json", "jsonp", "text".			            beforeSend:function(){},			            success:function(data){			            	$('.load').fadeOut("slow");			          		if(data.orderId>0){			          			$('.load').fadeOut("slow");			          				var u=encodeURI("http://h5.higegou.com/sheSaid/orderx?orderCode="+data.orderCode+"&uid=@usr.getUid()&aid="+aid);					          							          						          				window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid=@appid&redirect_uri="+u+"&response_type=code&scope=snsapi_base&state=123&connect_redirect=1#wechat_redirect";			          		}else{			          			_alert(data.msg);			          		}			            },			            complete: function(XMLHttpRequest, textStatus){			            },			            error: function(){			                _alert("提示请检查一下网络!");			                $('.load').fadeOut("slow");			            }        			         }); 						}				else				{					$('.load').fadeOut("slow");					_alert("请使用微信购买");				}		         }else{		        	 asuc=false;		        	 $('.load').fadeOut("slow");		        	_alert(data.msg); 		         }	           },		       complete: function(XMLHttpRequest, textStatus){		       },		      error: function(){		    	  $('.load').fadeOut("slow");		        _alert("提示请检查一下网络!");		      		      } 		 });	}//--></script><script type="text/javascript" src="@assets.CdnAssets.urlForAPIPublic("javascripts/sheSaidJs/noShareWX.js")"></script> }