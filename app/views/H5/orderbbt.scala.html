@(address:Address)(proinfo:Product)(usr:User)(sign:WxSign)(mcode:String)@views.html.sheSaid.main{<title>订单结算</title><script type="text/javascript" src="@assets.CdnAssets.urlForAPIPublic("javascripts/sheSaidJs/cityPanel/cityPanel.js")"></script><link rel="stylesheet" type="text/css" href="@assets.CdnAssets.urlForAPIPublic("stylesheets/sheSaidCSS/cityPanel/cityPanel.css")" media="all"><script src="@assets.CdnAssets.urlForAPIPublic("javascripts/sheSaidJs/alert.js")"></script><style>		    .certificates{				padding:6px 10px 10px;				}		 	.certificates b{				color:#ff314e;								font-size:12px;				font-weight:400;							}			.certificates p,.certificates input{				color:#303030;				font-size:13px;				line-height:28px;				border-radius:3px;				background:#e4e4e4;				padding:0 2%;				width:96%;				border:none;								}					.login-wrap{				position:absolute;				top:50%;				left:20px;				right:20px;				margin:-160px 0 0 0;				border-radius:6px;				background:#fff;				padding:30px;				box-shadow:0 0 3px #cacacd;						}			.login-wrap h2{				display:block;				text-align:center;				font-size:16px;				line-height:22px;				}				.login{				border-bottom:0;				}					.transparent{		      position: fixed;		      top:0;		      left:0;		      right:0;		      bottom:0;		      background:rgba(0,0,0,.5);		      }		      .person_input-wrap{		     min-height:44px;		     line-height:44px;		     }		    .person_input-wrap label{		     width:auto;		     padding:0;		     color:#abadb0;		     }		     .person_input{		     width:70%;		     }	  	   	  	    	  	  	  	        </style>}{<div class="container"><form name="form2" id="form2" method="post" action="/sheSaid/saveOrder"><input type="hidden" id="aid" name="aid" value="@if(address!=null){@address.getAddressId()}"/>				<input type="hidden" id="uid" name="uid" value="@usr.getUid()" />	 <div class="cont person" onclick="javascript:document.getElementById("showlogin").style.display='none';">  		 <div class="person_input-wrap">		<label>收货人信息</label>		 </div>                          <div class="person_input-wrap">              <label>姓名：</label>				<input type="text" class="person_input" placeholder="收货人真实姓名" id="Name" name="Name"  value="@address.getName()">              </div>              <div class="person_input-wrap">              <label>电话：</label>				<input type="tel" class="person_input" placeholder="手机号码" id="phone" name="phone" value="@address.getPhone()">              </div>              <div class="person_input-wrap">              <label>地址：</label>				<input type="text" class="person_input" name="city_dummy" id="city_dummy" placeholder="所在地区" value="@address.getProvince()" readOnly>                 <i class="ico_arrow_right"></i>              </div>              <div class="person_input-wrap">              <input type="text" class="person_input" placeholder="详细地址" id="address" name="address" value="@address.getAddress()">              </div>	       </div>	 @if(proinfo.getIsopenid()==1){	<div class="cont certificates">              <b>应海关要求请填写真实身份证信息，以确保正常收货！</b>              <input type="text" id="cardId" name="cardId" placeholder="身份证号" value="@address.getCardId()" />    </div>    }else{              <input type="hidden" id="cardId" name="cardId" value="@address.getCardId()" />              }              	 <div class="cont">               <div class="message_product">                  <div class="product_img">                  <img src="@proinfo.getListpic()" alt="@proinfo.getTitle()">                  </div>                  <div class="product_neme">@proinfo.getTitle()</div>                  <div class="product_info">                 	  <span>数量：<b>1</b></span>                 	  <em id="pricep">￥@proinfo.getRmbprice().toInt</em>					<input type="hidden" id="price" name="price" value="@proinfo.getRmbprice().toInt" />				</div>			</div>			@if(proinfo.getPostfee()>0){				<div class="cont">		<ul class="detail">			<li><span>结算明细</span> <em>订单总价：<b id="totalprice">￥@(proinfo.getPostfee().toInt+proinfo.getRmbprice().toInt)</b></em></li>						<li>				<div>					<span>运费</span> <em>￥@proinfo.getPostfee()</em>				</div>			</li>			<!-- 			<li>				<div>					<span>税费</span> <em>￥0</em>				</div>			</li>			-->		</ul>	</div>	}		<div class="cont fixed">				<div class="product_pay">                   <a href="#" class="btn btn_finish" id="onsubreg" onclick="submito()"><span id="innertxt">微信支付</span></a>		</div>                </div></form></div><div class="load" style='display: block;'></div><div class="transparent" id="showlogin" style="display:none"><div class="container" onclick=""><div class="login-wrap">	<h2>                  验证手机号<br>                  便于您按时收货    </h2>	<div class="login">		<form name="form1" id="form1" method="post" action="/api/checkUserVerify">		<input type="hidden" id="openid" name="openid" value="@usr.getOpenId()"/>		<input type="hidden" id="unionid" name="unionid" value="@usr.getUnionid()"/>		<div class="input-wrap input-wrap-b">			<input type="text" id="phonereg" name="phonereg" class="input tel" placeholder="手机号">		</div>		<div class="input-wrap">			<input type="hidden" id="imgcheck" name="imgcheck" />			<input type="text" id="verify_sms" name="verify_sms" class="input letter" placeholder="短信验证码">			<a href="#" class="btn btn_code"><span id="sendsms" onclick="setDivCenter()">发送验证码</span></a>		</div>		</form>	</div>	<div class="protocol">		<p>			<i class="new_check"></i><a href="http://ht.neolix.cn/www/service/agreement.html">嗨个购用户协议</a>		</p>		<p>			<a href="#" class="btn btn_finish" onclick="checkuser()">完成</a>		</p>	</div>	<a href="javascript:;" class="pop-pay-close" onclick="closeshowlogin()"></a></div>	</div></div>}{<script>              $(function(){				 $("#city_dummy").cityPanel();			  }) </script><script type="text/javascript"><!--$('.load').fadeOut("slow");function closeshowlogin(){	document.getElementById("showlogin").style.display="none";}var addressid='@address.getAddressId()';var asuc=true;var checkuserid='@usr.getUid()';function checkaddress(){	asuc=true;	 var reg = /^1\d{10}$/g; 	 if(!reg.test(document.getElementById("phone").value)){	 	_alert("请输入正确的手机号!");	 	asuc=false;	 	return false;	 }	 document.getElementById("phonereg").value=document.getElementById("phone").value;	if(document.getElementById("Name").value==""){	 	_alert("请输入收货人!");	 	asuc=false;	 	return false;	 }	if(document.getElementById("Name").value.length>16){	 	_alert("收货人不能超过16个字符!");	 	asuc=false;	 	return false;	 }	 if(document.getElementById("address").value==""){	 	_alert("请输入详细地址!");	 	asuc=false;	 	return false;	 }	 if(document.getElementById("address").value.length>100){		 	_alert("详细地址不能超过100个字符!");		 	asuc=false;		 	return false;	}	 	 if(document.getElementById("city_dummy").value==""){	 	_alert("请输入所在地区!");	 	asuc=false;	 	return false;	 }	 @if(proinfo.getIsopenid()==1){		 if(document.getElementById("cardId").value.length<15){			 _alert("请输入身份证号!");			 asuc=false;			 return false;		 }	 }	 }@if(usr.getUid()==0){		document.getElementById("onsubreg").onclick=function(){submitlogin();};}function submitlogin(){	checkaddress();	if(asuc==true)		document.getElementById("showlogin").style.display="";}function checkuser(){	var pho=document.getElementById("phonereg").value;  		//alert(pho);	var ver=document.getElementById("verify_sms").value;	var suc=true;		if (!$("#phonereg").val().match(/^1\d{10}$/g)) {		_alert("请输入正确的手机号");     	//document.getElementById("phone").focus();		suc=false;	}	else{    	if(ver.length<1){    		    		suc=false;    		_alert("请输入验证码")    		//document.getElementById("verify_sms").focus();    	}	}    		if(suc){$.ajax({        //提交数据的类型 POST GET        type:"POST",        //提交的网址        url:"/sheSaid/reguser",        //提交的数据        data:{uid:'@usr.getUid()',verify_sms:ver,phone:pho,unionid:'@usr.getUnionid()',openid:'@usr.getOpenId()',mcode:'bbt'},        //返回数据的格式        datatype: "json",//"xml", "html", "script", "json", "jsonp", "text"        //在请求之前调用的函数        beforeSend:function(){},        //成功返回之后调用的函数                    success:function(data){      		if(data.status=="1"){      			//alert("注册成功!");         			checkuserid=data.userid;      			addressid=data.aid;      			document.getElementById("uid").value=checkuserid      			document.getElementById("onsubreg").onclick=function(){submito();};      			saveeditaddress();      			//alert(addressid);      			if(addressid>0)      				submito();      			      			document.getElementById("showlogin").style.display="none";       		}else{      			_alert(data.msg);      		}        }   ,        //调用执行后调用的函数        complete: function(XMLHttpRequest, textStatus){        },        //调用出错执行的函数        error: function(){            //请求出错处理            _alert("请输入正确的验证码!");        }             });   	     }}function saveeditaddress(){		// alert(checkuserid);		checkaddress();		if(asuc){		 $.ajax({	            type:"POST",	            url:"/H5/saveaddress",	            data:{aid:addressid,uid:checkuserid,Name:document.getElementById("Name").value,phone:document.getElementById("phone").value,address:document.getElementById("address").value,city_dummy:document.getElementById("city_dummy").value,cardid:document.getElementById("cardId").value},	            datatype: "json",//"xml", "html", "script", "json", "jsonp", "text".	            beforeSend:function(){},  		           success:function(data){	        	   		         	if(data.status=="1"){			         		//alert("ok"+data.aid);		         		addressid=data.aid;			         }else{			        	 asuc=false;			        	_alert(data.msg); 			         }		           },			       complete: function(XMLHttpRequest, textStatus){			       },			      error: function(){			    	  asuc=false;			        _alert("提示请检查一下网络!");		      			      } 			 });		}}function sendorder(pid,ordercode){	$.ajax({	    type:"POST",	    url:"/H5/bbtorder",	    data:{pid:pid,ordercode:ordercode},	    datatype: "json",//"xml", "html", "script", "json", "jsonp", "text",	    beforeSend:function(){},	    success:function(data){		            		    }   ,	    complete: function(XMLHttpRequest, textStatus){	    },	    error: function(){	        _alert("请检查一下网络!");	    }        	 });}	function submito(){		var aid=document.getElementById("aid").value;		var uid=document.getElementById("uid").value;		var pid='@proinfo.getPid()';		var nums="1";//document.getElementById("count").value;				var datastr=pid+"_@proinfo.getRmbprice()_"+nums;			var suc=true;		aid=addressid;		if(aid.length<1 || uid.length<1 || pid.length<1){			_alert("请填写收货地址!");			suc=false;		}		//if(addressid==0){			saveeditaddress();		//}		aid=addressid;		if(suc && addressid>0){			//$('.load').fadeIn();			//如果0支付直接结单			var tf='(@proinfo.getRmbprice()*1+@proinfo.getPostfee()*1)';			if(tf.length>1)				tf=tf.replace("￥","");						/*微信支付**********************************************/				//alert("ok");				$.ajax({	            type:"POST",	            url:"/api/shoppingOrder_new",	            //提交的数据	            data:{datastr:datastr,uid:uid,addressid:aid,typ:7,mcode:'@mcode'},	            //返回数据的格式	            datatype: "json",//"xml", "html", "script", "json", "jsonp", "text".	            //在请求之前调用的函数	            beforeSend:function(){},	            //成功返回之后调用的函数            	            success:function(data){	            	$('.load').fadeOut("slow");	          			//微信支付						if(data.orderCode==undefined||data.orderCode==""||data.orderCode==null){							_alert(data.msg);							return false;						}else{																				var u=encodeURI("http://h5.higegou.com/H5/orderx?orderCode="+data.orderCode+"&uid=@usr.getUid()&pid=@proinfo.getPid()&aid="+aid+"&mm=@mcode");																          			setTimeout(function(){		          						          				window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx99199cff15133f37&redirect_uri="+u+"&response_type=code&scope=snsapi_base&state=123&connect_redirect=1#wechat_redirect";							},1000);						}	            }   ,	            complete: function(XMLHttpRequest, textStatus){	            },	            error: function(){	                $('.load').fadeOut("slow");	                _alert("提示请检查一下网络!");	            }        	         }); 			/*微信支付结束**********************************************/			}	 }//-->//setTimeout(function(){//	$('.load').fadeOut("slow");//},3000);</script><script>var checkisimg=false;var imgcheck="";function setDivCenter(){  		if ($("#phonereg").val().match(/^((1[0-9]{1})+\d{9})$/)) {		/*		 $.ajax({	            type:"POST",	            url:"/H5/checkimgVerify",	            data:{phone:$("#phonereg").val()},	            datatype: "json",//"xml", "html", "script", "json", "jsonp", "text".	            //在请求之前调用的函数	            beforeSend:function(){},	            success:function(data){    	            		          		if(data.status=="2"){	          			checkisimg=true;	          			verifySMS();	          		}else if(data.status=="1"){	          			showDiv();	          		}else{	          			_alert(data.msg);	          		}	            }   ,	            complete: function(XMLHttpRequest, textStatus){	            },	            error: function(){	                //请求出错处理	                _alert("发送失败!");	            }        	         	});   		*/		verifySMS();	}	else{   	 _alert("请输入正确的手机号!");			//document.getElementById("phone").focus();			return false;    }}function showDiv(){	document.getElementById("imgtmp").src=encodeURI("@routes.Application.imageValidate?temp="+(new Date().getTime().toString(36))+"\"");		var windowWidth = document.documentElement.clientWidth;   		 var windowHeight = document.documentElement.clientHeight;   		 var popupHeight = $("#showdiv").height();   		 var popupWidth = $("#showdiv").width();    	    var top = ($(window).height() - $("#showdiv").height())/2;   	    var left = ($(window).width() - $("#showdiv").width())/2;   	    var scrollTop = $(document).scrollTop();   	    var scrollLeft = $(document).scrollLeft();	    $("#showdiv").css({  	    	  "position": "absolute",   	    	  "top": (windowHeight-popupHeight)/2+$(document).scrollTop(),   	    	  "left": (windowWidth-popupWidth)/2   	    	 });   	   	    document.getElementById("showdiv").style.display="";}function closeDiv(){		imgcheck=document.getElementById("imgh").value;	document.getElementById("imgh").value="";		if(imgcheck.length<4){		_alert("请输入图形验证码")			}else{		//document.getElementById("sendsms").onclick=function(){verifySMS();};		document.getElementById("imgcheck").value=imgcheck;		document.getElementById("showdiv").style.display="none";		verifySMS();	}}		var flag='';	 var reg = /^1\d{10}$/g; 	var miao = 60;    function verifySMS(){        	//alert(iswx);    	    	//if($("#imgcheck").val().length==4)		//	checkisimg=true;    			//if(bw==true)			checkisimg=true;    	miao=60;    	//var iswx="0";    	//if(bw==true)    	//	iswx="1";    	    	var pho=document.getElementById("phonereg").value;      	var imc=document.getElementById("imgcheck").value;    	if ($("#phonereg").val().match(/^((1[0-9]{1})+\d{9})$/)) {    		if(checkisimg==true){	    		time_op();	    		 $.ajax({	            //提交数据的类型 POST GET	            type:"POST",	            //提交的网址	            url:"/H5/userVerify",	            //提交的数据	            data:{uid:"@usr.getUid()",phone:pho,reg:"0",imgcheck:imc,wx:1},	            //返回数据的格式	            datatype: "json",//"xml", "html", "script", "json", "jsonp", "text".	            //在请求之前调用的函数	            beforeSend:function(){},	            //成功返回之后调用的函数            	            success:function(data){                           	          		if(data.status=="1"){	          			_alert("验证码已成功发送!");	          		}else{	          			_alert(data.msg);	          		}	            }   ,	            //调用执行后调用的函数	            complete: function(XMLHttpRequest, textStatus){	            },	            //调用出错执行的函数	            error: function(){	                //请求出错处理	                _alert("发送失败!");	            }        	         	});       		}else{    			_alert("请输入图形验证码!");				return false;    		}         }         else{        	 _alert("请输入正确的手机号!");   			//document.getElementById("phone").focus();   			return false;         }    }    	function time_op() {			miao--;		if(miao>0){			document.getElementById("sendsms").innerHTML = miao+"秒";			document.getElementById("sendsms").onclick="";		}		else		{				//$("#sendsms").attr("onclick","verifySMS()");			document.getElementById("sendsms").onclick=function(){setDivCenter();};			document.getElementById("sendsms").innerHTML = "重新发送";		}		if(miao>0){			setTimeout("time_op()", "1000");		}	}		</script>@if(sign!=null){<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script><script>//alert(location.href.split('#')[0])var linkurl=location.href.split('#')[0];var sign="@sign";wx.config({    debug: false,    appId: '@sign.getAppId()',    timestamp: '@sign.getTimstr()',    nonceStr: '@sign.getNostr()',    signature: '@sign.getSign()',    jsApiList: ['checkJsApi',                'onMenuShareTimeline',                'onMenuShareAppMessage'    ]  });	wx.ready(function () {    // 1 判断当前版本是否支持指定 JS 接口，支持批量判断		wx.checkJsApi({		  jsApiList: [			'getNetworkType',			'previewImage'		  ],		  success: function (res) {			//alert(JSON.stringify(res));		  }		});		wx.onMenuShareTimeline({		    title: '@sign.getSharetitle', // 分享标题		    link: '@sign.getShareurl()', // 分享链接		    imgUrl: '@sign.getShareimg()', // 分享图标		    success: function () { 		        // 用户确认分享后执行的回调函数		    },		    cancel: function () { 		        // 用户取消分享后执行的回调函数		    }		});		wx.onMenuShareAppMessage({			  title: '@sign.getSharetitle',			  desc: '@sign.getSharecontent()',			  link: '@sign.getShareurl()',			  imgUrl: '@sign.getShareimg()',			  success: function (res) {				//alert('已分享');			  },			  cancel: function (res) {				//alert('已取消');			  }		  });  });  wx.error(function (res){		//alert(res.errMsg);  });</script>} } 