@(address:Address)(cartlist:List[vo.shoppingCart.ShoppingCartItemVO])(usr:User)(Isopenid:String)(Postfee:String)(taxfee:String)(tfee:String)(datastr:String)(pidstr:String)(addrSign:WxSign)(wxtoken:String)@views.html.sheSaid.main{<title>订单结算</title><script type="text/javascript" src="@assets.CdnAssets.urlForAPIPublic("javascripts/sheSaidJs/cityPanel/cityPanel.js")"></script><link rel="stylesheet" type="text/css" href="@assets.CdnAssets.urlForAPIPublic("stylesheets/sheSaidCSS/cityPanel/cityPanel.css")" media="all"><script src="@assets.CdnAssets.urlForAPIPublic("javascripts/sheSaidJs/alert.js")"></script><style>		    .certificates{				padding:6px 10px 10px;				}		 	.certificates b{				color:#ff314e;								font-size:12px;				font-weight:400;							}			.certificates p,.certificates input{				color:#303030;				font-size:13px;				line-height:28px;				border-radius:3px;				background:#e4e4e4;				padding:0 2%;				width:96%;				border:none;								}					.transparent{		      position: fixed;		      top:0;		      left:0;		      right:0;		      bottom:0;		      background:rgba(0,0,0,.5);		      }	  		       .person_input-wrap label{			    float:left;			    margin:0;			    padding:0;			    line-height:46px;			    width:50px;			   }			   .person_input-wrap p{			    margin-left:50px;			    } 			   .person_input{			    width:96%;			    text-overflow:ellipsis;			   }   	  	    	  	  	  	        </style>}{<div class="container"><form name="form1" id="form1" method="post" action="/sheSaid/saveOrder">		<input type="hidden" id="aid" name="aid" value="@if(address!=null){@address.getAddressId()}"/>		<input type="hidden" id="proid" name="proid" value="0" />		<input type="hidden" id="uid" name="uid" value="@usr.getUid()" />		<input type="hidden" id="count" name="count" value="1" />	         <div class="nav-top">               <p>购物车</p>               <i class="ico-return" onclick="javascript:window.location.href='/H5/orderprocart';"></i>               <i class="ico-basket" onclick="javascript:window.location.href='@assets.CdnAssets.H5_SHOPPING_URL("")'"></i>         </div>        <!-- 选择微信地址 -->			<div class="address" id="wxaddress" name="wxaddress" onclick="selectwxaddress()" style="margin-top:5px;display:none">                <div class="address_info">                    <p class="name">                        <label id="wxname">@if(address.getName()==""){请填写收货人信息}else{@address.getName()}</label>                        <label id="wxphone">@if(address.getName()!=""){@address.getPhone()}</label>                    </p>                    <p class="txt" id="wxdress">                      @address.getProvince()@address.getAddress()                    </p>                </div>                <i class="ico_arrow_right"></i>            </div>         <!-- 微信选择地址结束 -->				 <div class="cont person" style="z-index:1000" id="showaddress" name="showaddress">      			 <div class="person_input-wrap">			 <label>收货人信息</label>			 </div>              <div class="person_input-wrap">              <label>姓名：</label>				<p><input type="text" class="person_input" placeholder="收货人真实姓名" id="Name" name="Name"  value="@address.getName()"></p>              </div>              <div class="person_input-wrap">              <label>电话：</label>				<p><input type="tel" class="person_input" placeholder="手机号码" id="phone" name="phone" value="@address.getPhone()"></p>              </div>              <div class="person_input-wrap">              <label>地址：</label>				<p><input type="text" class="person_input city_dummy" name="city_dummy" id="city_dummy" placeholder="所在地区" value="@address.getProvince()" readOnly></p>                 <i class="ico_arrow_right city_dummy"></i>              </div>              <div class="person_input-wrap">              <p><input type="text" class="person_input" placeholder="详细地址" id="address" name="address" value="@address.getAddress()"></p>              </div>           	</div>	       @if(Isopenid=="1"){			<div class="cont certificates">		              <b>应海关要求请填写真实身份证信息，以确保正常收货！</b>		              <input type="text" id="cardId" name="cardId" placeholder="身份证号" value="@address.getCardId()" />		    </div>		    }else{              <input type="hidden" id="cardId" name="cardId" value="@address.getCardId()" />              }   	   @if(cartlist!=null){   	@for(proinfo <- cartlist){	<div class="cont product">		<div class="product_img">			<img src="@proinfo.img" alt="@proinfo.title">		</div>		<div class="product_neme">@Html(proinfo.title)</div>		<div class="product_info">			<span>数量：<b id="pricep">@proinfo.counts</b></span>			<em>￥@if(proinfo.rmbprice.indexOf(".")>=0){@proinfo.rmbprice.toDouble}else{@proinfo.rmbprice.toInt}</em>		</div>	</div>		}	}@if(Postfee.toDouble>0 || taxfee.toDouble>0){	<div style="margin-top:10px;background-color:#fff">		<ul class="detail">						<li>				<div>					<span>运费</span> <em id="postfee">￥@Postfee</em>				</div>			</li>						@if(taxfee.toDouble>0){						<li>							<div>											<span>费税</span> <em>￥@taxfee</em>										</div>									</li>			}		</ul>	</div>}<div class="cont-h115"></div>	<div class="cont fixed">		<div class="product_pay">			<p>				<em>合计:<b id="hjprice">￥@tfee</b></em>包含运费			</p>			<a href="#" class="btn btn_finish" id="onsubreg" onclick="submito()"><span id="innertxt">微信支付</span></a>		</div>	</div></form></div><div class="load" style='display: block;z-index:3000'></div>}{<script>              $(function(){				 $(".city_dummy").cityPanel();			  })			   </script> <script type="text/javascript" src="@assets.CdnAssets.urlForAPIPublic("javascripts/sheSaidJs/noShareWX.js")"></script><script type="text/javascript"><!--var ua = window.navigator.userAgent.toLowerCase();var bw=false;if(ua.match(/MicroMessenger/i) == 'micromessenger'){	bw=true;	document.getElementById("showaddress").style.display="none";	document.getElementById("wxaddress").style.display="";	//document.getElementById("Name").value="";			//document.getElementById("phone").value="";			//document.getElementById("city_dummy").value="";			//document.getElementById("address").value="";}else{	bw=false;	document.getElementById("innertxt").innerHTML="支付宝支付";	document.getElementById("showaddress").style.display="";	document.getElementById("wxaddress").style.display="none";}//选择微信地址function selectwxaddress(){		@if(addrSign!=null && wxtoken!=""){		callpay();	}else{		window.location.href="/H5/wxauth_address?flg=procart";	}}/* * 调用微信地址JS */ function callpay() { 	if (typeof WeixinJSBridge == "undefined"){ 		if( document.addEventListener ){ 			document.addEventListener('WeixinJSBridgeReady', jsApiCall, false); 		}else if (document.attachEvent){ 			document.attachEvent('WeixinJSBridgeReady', jsApiCall);  			document.attachEvent('onWeixinJSBridgeReady', jsApiCall); 		} 	}else{ 		jsApiCall(); 	} } function jsApiCall() {	 @if(addrSign!=null){ 	WeixinJSBridge.invoke( 		'editAddress',{            "appId" : "@addrSign.getAppId()",     //公众号名称，由商户传入                 "scope":"jsapi_address",            "signType":"sha1",            "addrSign":"@addrSign.getSign()",            "timeStamp":"@addrSign.getTimstr()",         //时间戳，自1970年以来的秒数                 "nonceStr" : "@addrSign.getNostr()" //随机串           }, 		function(res){     	   //alert(res.err_msg); 			if(res.err_msg == "edit_address:ok" ) { 				//成功 				document.getElementById("Name").value=res.userName; 				//alert(document.getElementById("Name").value); 				document.getElementById("phone").value=res.telNumber; 				document.getElementById("city_dummy").value=res.addressCitySecondStageName+res.addressCountiesThirdStageName; 				document.getElementById("address").value=res.addressDetailInfo; 				document.getElementById("showaddress").style.display="none";	 				document.getElementById("wxdress").innerHTML=res.addressCitySecondStageName+res.addressCountiesThirdStageName+res.addressDetailInfo; 				document.getElementById("wxname").innerHTML=res.userName; 				document.getElementById("wxphone").innerHTML="<br>"+res.telNumber; 			}else{ 				//window.location.href="/H5/wxauth_address?flg=pro"; 				document.getElementById("showaddress").style.display=""; 				document.getElementById("wxaddress").style.display="none"; 			} 		} 	);	 } } /***********调用微信地址结束**********/@if(cartlist==null){	document.getElementById("onsubreg").onclick="";}var addressid='@address.getAddressId()';var asuc=true;var checkuserid='@usr.getUid()';function checkaddress(){	asuc=true;	 var reg = /^1\d{10}$/g; 	 if(!reg.test(document.getElementById("phone").value)){	 	if(!bw)	 		_alert("请输入正确的手机号!");	 	else	 		_alert("请选择地址");	 	asuc=false;	 	return false;	 }	 	if(document.getElementById("Name").value==""){	 	if(!bw)	 		_alert("请输入收货人!");	 	else	 		_alert("请选择地址");	 	asuc=false;	 	return false;	 }	if(document.getElementById("Name").value.length>16){	 	if(!bw)	 		_alert("收货人不能超过16个字符!");	 	else	 		_alert("请选择地址");	 	asuc=false;	 	return false;	 }	 if(document.getElementById("address").value==""){	 	if(!bw)	 		_alert("请输入详细地址!");	 	else	 		_alert("请选择地址");	 	asuc=false;	 	return false;	 }	 if(document.getElementById("address").value.length>100){		 	if(!bw)		 		_alert("详细地址不能超过100个字符!");		 	else		 		_alert("请选择地址");		 	asuc=false;		 	return false;	}	 	 if(document.getElementById("city_dummy").value==""){	 	if(!bw)	 		_alert("请输入所在地区!");	 	else	 		_alert("请选择地址");	 	asuc=false;	 	return false;	 }	 @if(Isopenid=="1"){		 if(document.getElementById("cardId").value.length<15){			 _alert("请输入身份证号!");			 asuc=false;			 return false;		 }	 }}$('.load').fadeOut("slow");	function submito(){	var aid="@if(address!=null){address.getAddressId()}";		var aid=document.getElementById("aid").value;		var uid=document.getElementById("uid").value;				var datastr='@datastr';						var suc=asuc;				aid=addressid;		if(aid.length<1 || uid.length<1){			_alert("请填写收货地址!");			suc=false;		}		@if(Isopenid=="1"){			 if(document.getElementById("cardId").value.length<15){				 addressid=0;				 aid=0;				 _alert("请输入身份证号!");				 return false;			 }		}		aid=addressid;		//alert(aid);		checkaddress();		if(asuc){			$('.load').fadeIn();			 $.ajax({		            type:"POST",		            url:"/H5/saveaddress",		            data:{aid:addressid,uid:checkuserid,Name:document.getElementById("Name").value,phone:document.getElementById("phone").value,address:document.getElementById("address").value,city_dummy:document.getElementById("city_dummy").value,cardid:document.getElementById("cardId").value,pids:'@pidstr'},		            datatype: "json",//"xml", "html", "script", "json", "jsonp", "text".		            beforeSend:function(){},  			           success:function(data){	        	   			         	if(data.status=="1"){				         		//alert("ok"+data.aid);			         		addressid=data.aid;			         		if(bw){								$.ajax({					            type:"POST",					            url:"/api/shoppingOrder_new",					             data:{datastr:datastr,uid:uid,addressid:addressid,typ:7,mcode:'H5'},					            datatype: "json",//"xml", "html", "script", "json", "jsonp", "text".					            beforeSend:function(){},					            success:function(data){					            	$('.load').fadeOut("slow");					          		if(data.orderId>0){					          			$('.load').fadeOut("slow");					          			if(bw==true){					          				var u=encodeURI("http://api.higegou.com/H5/orderxpro?orderCode="+data.orderCode+"&uid=@usr.getUid()&aid="+aid);					          							          							          				window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx99199cff15133f37&redirect_uri="+u+"&response_type=code&scope=snsapi_base&state=123&connect_redirect=1#wechat_redirect";					          			}					          			else					          				{						          				var u="/H5/orderxpro?orderCode="+data.orderCode+"&uid=@usr.getUid()&aid="+aid;							          			window.location.href=u;					          				}					          		}else{					          			_alert(data.msg);					          		}					            },					            complete: function(XMLHttpRequest, textStatus){					            },					            error: function(){					                _alert("提示请检查一下网络!");					                $('.load').fadeOut("slow");					            }        					         }); 								}						else						{							//支付宝支付操作							$.ajax({					            type:"POST",					            url:"/api/shoppingOrder_new",					            data:{datastr:datastr,uid:uid,addressid:addressid,typ:7,mcode:'H5'},					            datatype: "json",//"xml", "html", "script", "json", "jsonp", "text".					            beforeSend:function(){},					            success:function(data){					            	$('.load').fadeOut("slow");					            	//alert("生成订单:"+data.orderCode);					            	var backurl="http://182.92.227.140:9004/H5/alipayreturn";					          		if(data.orderId>0){						          			//alert(data.orderCode);					          			window.location.href="/H5/alipay?out_trade_no="+data.orderCode+"&total_fee="+data.totalfee+"&uid="+uid;					          			//var u="/api/alipaywapendorse?ordercode="+data.orderCode+"&amount=0.01&backurl="+backurl;																	//window.location.href=u;										          		}else{					          			_alert(data.msg);					          		}					            },					            complete: function(XMLHttpRequest, textStatus){					            },					            error: function(){					            	 $('.load').fadeOut("slow");					                _alert("处理失败!");					               					            }        					         }); 						}				     }else{				        	 asuc=false;				        	 $('.load').fadeOut("slow");				        	_alert(data.msg);				         }			           },				       complete: function(XMLHttpRequest, textStatus){				       },				      error: function(){				    	  $('.load').fadeOut("slow");				        _alert("提示请检查一下网络!");		      				      } 				 });		} }//--></script> }